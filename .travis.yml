---
language: go

go:
  - '1.13.x'

go_import_path: github.com/brancz/kube-rbac-proxy

env:
  - GO111MODULE=on

cache:
  directories:
  - $GOCACHE
  - $GOPATH/pkg/mod

services:
  - docker

jobs:
  include:
    - name: Push container images
      stage: push-docker-image
      script:
        - "sudo chmod o+x /etc/docker"
        - "echo ${QUAY_PASSWORD} | docker login -u ${QUAY_USERNAME} --password-stdin quay.io"
        - '[ "$TRAVIS_BRANCH" = "master" ] && VERSION="$(git rev-parse --abbrev-ref HEAD | tr / -)-$(date +%Y-%m-%d)-$(git rev-parse --short HEAD)" make push'
        - '[ -n "$TRAVIS_TAG" ] && VERSION=$TRAVIS_TAG make push'

stages:
  - name: test
  - name: push-docker-image
    if: (type != pull_request)
